<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ALERT Software documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./css/custom.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="configuration/intro.html"><strong aria-hidden="true">1.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="configuration/first_use.html"><strong aria-hidden="true">1.1.</strong> First use</a></li><li class="chapter-item expanded "><a href="configuration/setup_gemc.html"><strong aria-hidden="true">1.2.</strong> Setup GEMC</a></li><li class="chapter-item expanded "><a href="configuration/run.html"><strong aria-hidden="true">1.3.</strong> Run my code</a></li></ol></li><li class="chapter-item expanded "><a href="tutorials/intro.html"><strong aria-hidden="true">2.</strong> Tutorials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorials/alert_gcard.html"><strong aria-hidden="true">2.1.</strong> Simulation parameters</a></li><li class="chapter-item expanded "><a href="tutorials/new_entry_bank.html"><strong aria-hidden="true">2.2.</strong> New entry, AHDC::adc</a></li><li class="chapter-item expanded "><a href="tutorials/new_ahdc_bank.html"><strong aria-hidden="true">2.3.</strong> New bank, AHDC::wf136</a></li></ol></li><li class="chapter-item expanded "><a href="ahdc/simu_signal.html"><strong aria-hidden="true">3.</strong> AHDC signal</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="references.html">Références</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ALERT Software documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>This page is a documentation of my work related to the ALERT software. I work on the simulation of the AHDC signal. A description of the project and the results are accessible in <a href="https://ftouchte.github.io/projects/index.html">Preparation of the ALERT experiment at JLab</a> (see the project of September 2024).</p>
<p>The simulation is based on GEMC. The following lines describe the steps to run my code.</p>
<p><img src="./ahdh_signal_mechanism.png" alt="Mechanism" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>The must simple way to run my code is to have access to the JLab <strong>ifarm</strong>. Here are some useful command lines :</p>
<pre><code class="language-shell">ssh -XY username@scilogin.jlab.org
</code></pre>
<pre><code class="language-shell">ssh -XY ifarm
</code></pre>
<p>To run the full simulation chain, we need to load the CLAS12 modules, ...</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="first-use"><a class="header" href="#first-use">First use</a></h1>
<p>This section concerns people that are not familiar with the software. For others, it is a prerequisite to expect the same results as mine. It is based on the <a href="https://clasweb.jlab.org/wiki/index.php/ALERT_Software_and_Simulations/GEMC_coatjava_setup_on_farm">official ALERT software wiki</a>.</p>
<h2 id="preamble"><a class="header" href="#preamble">Preamble</a></h2>
<p>If you have the correct right access, we recommend to create a new work space following these commande line :</p>
<pre><code class="language-shell">cd /work/clas12/users/
</code></pre>
<pre><code class="language-shell">mkdir yourjlabusername
</code></pre>
<pre><code class="language-shell">cd yourjlabusername 
</code></pre>
<h2 id="setup-default-clas12-software-modules"><a class="header" href="#setup-default-clas12-software-modules">Setup "default" CLAS12 software modules</a></h2>
<p>Run these command lines :</p>
<pre><code class="language-shell">module use /scigroup/cvmfs/hallb/clas12/sw/modulefiles
module load clas12
module switch gemc/dev
</code></pre>
<p>This set of commands can be added into your .login file in your home directory.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup-gemc"><a class="header" href="#setup-gemc">Setup GEMC</a></h1>
<p>In your work space (<code>/work/clas12/users/yourjlabusername</code>), create a new repository named <code>gemc</code></p>
<pre><code class="language-shell">mkdir gemc
cd gemc
</code></pre>
<h2 id="gemc-source"><a class="header" href="#gemc-source">GEMC source</a></h2>
<p>Now, clone my version of GEMC :</p>
<pre><code class="language-shell">git clone git@github.com:ftouchte/gemc_source.git source
</code></pre>
<p>N.B: The repository has been renamed <code>source</code>.</p>
<p>If you don't have a ssh key, you will get an error. You can learn how to create one and add this in your GitHub account. Then you can re-use the same command. If you don't want to create a ssh key, you can use :</p>
<pre><code class="language-shell">git clone https://github.com/ftouchte/gemc_source.git source
</code></pre>
<p>Now go inside the directory and compile gemc.</p>
<pre><code class="language-shell">cd source
scons -j4
</code></pre>
<p>An executabe called <strong>gemc</strong> has been created.</p>
<!-- **N.B:** At the date of June 26 2024, this repository contains ROOT codes. To avoid error, you have to use a version of ROOT based on C++14. To do so, you can download a pre-compile version of ROOT followinf these [instructions](https://root.cern/install/#download-a-pre-compiled-binary-distribution). -->
<!-- You have to correct right access, you just source this version :

``` shell
source /w/hallb-scshelf2102/clas12/users/touchte/root/bin/thisroot.csh
``` -->
<h2 id="gemc-detector"><a class="header" href="#gemc-detector">GEMC detector</a></h2>
<p>Go back in your working space (<code>/work/clas12/users/yourjlabusername/gemc</code>) and clone this repository:</p>
<pre><code class="language-shell">git clone git@github.com:mpaolone/detectors.git detectors
</code></pre>
<p>or</p>
<pre><code class="language-shell">git clone https://github.com/mpaolone/detectors.git detectors
</code></pre>
<p>Now go inside the directory</p>
<pre><code class="language-shell">cd detectors/clas12/alert
</code></pre>
<p>and copy and paste the following lines in the terminal (line by line)</p>
<pre><code class="language-shell">cd ../targets
./targets.pl config.dat
cd ../alert/ahdc
run-groovy factory.groovy --variation default --runnumber 11
run-groovy factory.groovy --variation rga_fall2018 --runnumber 11
./ahdc.pl config.dat
cd ../atof
run-groovy factory.groovy --variation default --runnumber 11
run-groovy factory.groovy --variation rga_fall2018 --runnumber 11
./atof.pl config.dat
cd ../external_shell_nonActif
./alertshell.pl config.dat
cd ../He_bag
./hebag.pl config.dat
cd ../ 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="run-my-code"><a class="header" href="#run-my-code">Run my code</a></h1>
<p>At this step, everything is setup. Go in the directory where the geometry of the ALERT detector has been defined (<code>yourpathto/gemc/detectors/clas12/alert</code>)</p>
<p>Example of run :</p>
<pre><code class="language-shell">/yourpathto/gemc/source/gemc alert.gcard -OUTPUT='hipo, ten_events.hipo' -N=10 -USE_GUI=0
</code></pre>
<p>Explanation :</p>
<ul>
<li>
<p><strong>/yourpathto/gemc/source/gemc</strong> is the executable that has been generated after compiling the gemc source code (<code>scons -j4</code>)</p>
</li>
<li>
<p><strong>alert.gacrd</strong> is the configuration file that contains the geometry of the ALERT detector. It also allows to define the kind of particle to be generated, their initial position and momentum coordinates...</p>
</li>
<li>
<p><strong>-OUTPUT='hipo, ten_events.hipo'</strong> sets the name of the output file. In this case, <em>ten_events.hipo</em> can be replace by <em>myfilename.hipo</em>.</p>
</li>
<li>
<p><strong>-N=10</strong> sets the number of events to be generated.</p>
</li>
<li>
<p><strong>-USE_GUI=0</strong> when this option is set to 1, a user interface appears.</p>
</li>
</ul>
<h2 id="analysis"><a class="header" href="#analysis">Analysis</a></h2>
<p>To view the content of the file on the ifarm, use <strong>hipo-utils</strong></p>
<pre><code>hipo-utils -dump ten-events.hipo
</code></pre>
<p>N.B : This command line is already available on the ifarm. To use it on a local computer, follow the instructions of <a href="https://userweb.jlab.org/~gavalian/docs/sphinx/hipo/html/chapters/hipo_java.html">HIPO Utilities JAVA</a>.</p>
<p>Tips : In your equivalent <code>.bashrc</code> file, define this alias</p>
<pre><code class="language-bash">alias hipo-utils="/yourpathto/bin/hipoutils.sh"
</code></pre>
<p><img src="configuration/./images/hipo-utils2.png" alt="hipo-utils2" />
<img src="configuration/./images/hipo-utils3.png" alt="hipo-utils3" /></p>
<p>To go further, visit <a href="https://clasweb.jlab.org/wiki/index.php/CLAS12_Software_Center#tab=Analysis">CLAS12 Software Center / Analysis</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tutorials"><a class="header" href="#tutorials">Tutorials</a></h1>
<p>As it's much simple to learn from examples...</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generate-a-particle"><a class="header" href="#generate-a-particle">Generate a particle</a></h1>
<h2 id="particle"><a class="header" href="#particle">Particle</a></h2>
<p>The type of particle, the iniatial coordinates, momentum, ... are defined in a file called <strong>alert.gcard</strong> accessible in <code>gemc/detectors/clas12/alert</code>. Here is an example  of such a file.</p>
<pre><code class="language-json">&lt;gcard&gt;
	
<span class="boring">	&lt;!-- target. ALERT target --&gt;
</span><span class="boring">	&lt;detector name="../targets/target" factory="TEXT" variation="alert"/&gt; 
</span><span class="boring">		
</span><span class="boring">	&lt;!-- Implementation ATOF, ahdc --&gt;
</span><span class="boring">	&lt;detector name="atof/atof" factory="TEXT" variation="default"/&gt;
</span><span class="boring">	&lt;detector name="ahdc/ahdc" factory="TEXT" variation="default"/&gt;
</span><span class="boring">	&lt;detector name="./external_shell_nonActif/alertshell" factory="TEXT" variation="original"/&gt;
</span><span class="boring">
</span><span class="boring">	&lt;!-- He bag --&gt;
</span><span class="boring">	&lt;detector name="./He_bag/hebag" factory="TEXT" variation="original"/&gt;
</span><span class="boring">
</span><span class="boring">	&lt;!-- hall field --&gt;
</span><span class="boring">	&lt;option name="HALL_FIELD"  value="clas12-newSolenoid"/&gt;
</span><span class="boring">
</span><span class="boring">	&lt;!-- fields, precise mode --&gt;
</span><span class="boring">	&lt;option name="FIELD_PROPERTIES" value="TorusSymmetric,     2*mm, G4ClassicalRK4, linear"/&gt;
</span><span class="boring">	&lt;option name="FIELD_PROPERTIES" value="clas12-newSolenoid, 1*mm, G4ClassicalRK4, linear"/&gt;
</span><span class="boring">
</span><span class="boring">	&lt;option name="INTEGRATEDRAW" value="*"/&gt;
</span><span class="boring">
</span><span class="boring">	&lt;option name="PHYSICS" value="STD + FTFP_BERT"/&gt;
</span><span class="boring">	&lt;option name="SAVE_ALL_MOTHERS" value="0"/&gt;
</span><span class="boring">	
</span>	&lt;!-- beam conditions --&gt;
	&lt;option name="BEAM_P"   value="proton, 160*MeV, 90.0*deg, 0*deg"/&gt;
 	&lt;option name="SPREAD_P"  value="90*MeV, 30.0*deg, 180*deg"/&gt;
	
	&lt;option name="BEAM_V"    value="(0, 0, 0)cm"/&gt;
	&lt;option name="SPREAD_V"  value="(0.0, 15.0)cm"/&gt;

<span class="boring">	&lt;!--  Run Number 11, picked up by digitization routines --&gt;
</span><span class="boring">	&lt;option name="RUNNO"    value="11" /&gt;
</span><span class="boring">	&lt;option name="DIGITIZATION_VARIATION"  value="default" /&gt;
</span><span class="boring">	
</span><span class="boring">	&lt;option name="OUTPUT" value="hipo, out.hipo"/&gt;
</span><span class="boring">
</span>&lt;/gcard&gt;
</code></pre>
<p>The part of interest is called <strong>beam conditions</strong>. With this configuration file, the software will generate <strong>proton</strong> with momentum <strong>\(p\) = 160 MeV</strong> oriented along <strong>\(\theta\) = 90°</strong> and <strong>\(\phi\) = 0°</strong>. In fact, no ! Indeed, due to the option <em>SPREAD_P</em>, the real values are uniform draws :</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">parameters</th><th style="text-align: center">values</th></tr></thead><tbody>
<tr><td style="text-align: center">\(p\)</td><td style="text-align: center"><strong>160 MeV ± 90 MeV</strong></td></tr>
<tr><td style="text-align: center">\(\theta\)</td><td style="text-align: center"><strong>90° ± 30°</strong></td></tr>
<tr><td style="text-align: center">\(\phi\)</td><td style="text-align: center"><strong>0° ± 180°</strong></td></tr>
</tbody></table>
</div>
<p>This is the same logic for the position (<em>BEAM_V</em> and <em>SPREAD_V</em>). In other words :</p>
<pre><code class="language-json">&lt;option name="BEAM_P"   value="type_of_particle, p*MeV, theta*deg, phi*deg"/&gt;
&lt;option name="SPREAD_P"  value="p*MeV, theta*deg, phi*deg"/&gt;
&lt;option name="BEAM_V"    value="(x,y,z)cm"/&gt;
&lt;option name="SPREAD_V"  value="(r=sqrt(x²+y²),z)cm"/&gt;
</code></pre>
<p>Reference <a href="https://gemc.jlab.org/gemc/html/documentation/options.html#gcard">GEMC options</a>. The following plot shows the momentum distribution of ten thousands particle generated in GEMC with the above <strong>alert.gcard</strong>. We can see that all the parameters are centered in the values defined in <em>BEAM_P</em>. The widths of the distributions correspond to the value defined in <em>SPREAD_P</em>.</p>
<p><img src="tutorials/./mc_particle.png" alt="mc_particle.png" /></p>
<p><strong>N.B</strong></p>
<ul>
<li>Use <code>./gemc -BEAM_P="show_all"</code> to print the list of G4 supported particles.</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">particle</th><th style="text-align: center">pid</th></tr></thead><tbody>
<tr><td style="text-align: center">proton</td><td style="text-align: center">2212</td></tr>
<tr><td style="text-align: center">neutron</td><td style="text-align: center">2112</td></tr>
<tr><td style="text-align: center">alpha</td><td style="text-align: center">1000020040</td></tr>
<tr><td style="text-align: center">He3</td><td style="text-align: center">1000020030</td></tr>
<tr><td style="text-align: center">triton</td><td style="text-align: center">1000010030</td></tr>
</tbody></table>
</div>
<h2 id="more"><a class="header" href="#more">More</a></h2>
<ol>
<li>What does the “variation” attribute in <code>&lt;detector ...&gt;</code> represent?</li>
</ol>
<pre><code class="language-json">&lt;!-- target. ALERT target --&gt;
&lt;detector name="../targets/target" factory="TEXT" variation="alertHe"/&gt;

&lt;!-- Implementation ATOF, ahdc --&gt;
	&lt;detector name="atof/atof" factory="TEXT" variation="default"/&gt;
	&lt;detector name="ahdc/ahdc" factory="TEXT" variation="default"/&gt;
	&lt;detector name="./external_shell_nonActif/alertshell" factory="TEXT" variation="original"/&gt;

	&lt;!-- He bag --&gt;
	&lt;detector name="./He_bag/hebag" factory="TEXT" variation="original"/&gt;
</code></pre>
<p>It represents a specific configuration. These configurations are defined in <code>@allconfs</code>:</p>
<ul>
<li><a href="https://github.com/gemc/detectors/blob/main/clas12/targets/targets.pl"><code>gemc/detectors/clas12/targets/targets.pl</code></a></li>
<li><code>gemc/detectors/clas12/alert/thisDet/thisDet.pl</code> where thisDet == {He_bag, ahdc or atof}</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="add-new-entries-in-ahdcadc"><a class="header" href="#add-new-entries-in-ahdcadc">Add new entries in AHDC::adc</a></h1>
<p>On the <strong>ifarm</strong>, we can see the content of an hipo file using :</p>
<pre><code>hipo-utils -dump myfile.hipo
</code></pre>
<p>This figure shows a typical output. It displays the content of the AHDC::adc bank. In the following, we will see how to add a new entry.</p>
<p><img src="tutorials/./file.hipo.png" alt="An example of hipo file" /></p>
<h2 id="step-1"><a class="header" href="#step-1">Step 1</a></h2>
<p>Go in <a href="https://github.com/ftouchte/gemc_source/blob/main/hitprocess/clas12/alert/ahdc_hitprocess.cc">/gemc/source/hitprocess/clas12/alert/ahdc_hitprcess.cc</a> and modify the function <code>ahdchitprocess::integrateDgtz()</code>.</p>
<pre><code class="language-cpp">map&lt;string, double&gt; ahdc_HitProcess::integrateDgt(MHit* aHit, int hitn) {
    // starting part of the code

    dgtz["hitn"]      = hitn;
	dgtz["sector"]    = sector;
	dgtz["layer"]     = layer;
	dgtz["component"] = component;
	dgtz["ADC_order"] = 0;
<span class="boring">	dgtz["ADC_ADC"]   = (int) output["max_value"]; // adc 
</span><span class="boring">	dgtz["ADC_time"]  = (float) output["t_ovr"]; // ns
</span><span class="boring">	dgtz["ADC_ped"]   = (int) output["noise_level"]; // adc
</span><span class="boring">	dgtz["ADC_integral"] = (int) output["integral"]; // adc per 44 ns
</span><span class="boring">	dgtz["ADC_timestamp"] = (long) output["t_start"]; // ns
</span>
    // MY NEW ENTRY
    dgtz["ADC_newEntry"] = value_of_my_newEntry; 

<span class="boring">	dgtz["TDC_order"] = 0;
</span>	dgtz["TDC_TDC"]   = output["t_start"];
		
	// remaining part of the code
	
	return dgtz;
} // end of the funtion
</code></pre>
<h2 id="step-2"><a class="header" href="#step-2">Step 2</a></h2>
<p>Go in <a href="https://github.com/ftouchte/gemc_source/blob/main/output/hipoSchemas.cc">gemc/source/output/hipoSchemas.cc</a> and modify the function <code>HipoSchema :: HipoSchema()</code>. I add <code>"newEntry/F"</code> in <code>alertAhdcchema.parse("...")</code>. The letter "F" is the type of my new entry, it can be I, S, B, F, D, or L (there is a comment about them in the code, you can check check).</p>
<pre><code class="language-cpp">HipoSchema :: HipoSchema()
{
	// starting part of the code

    // detectors

    alertAhdcADCchema.parse("sector/B, layer/B, component/S, order/B, ADC/I, time/F, ped/S, integral/I, timestamp/L, newEntry/F");
	alertAhdcTDCchema.parse("sector/B, layer/B, component/S, order/B, TDC/I, ped/S");
	alertAtofADCchema.parse("sector/B, layer/B, component/S, order/B, ADC/I, time/F, ped/S");

    // remaining part of the code
}
</code></pre>
<h2 id="step-3-can-be-skipped"><a class="header" href="#step-3-can-be-skipped">Step 3 (can be skipped)</a></h2>
<p>Nothing to do, just understanding what going on. During the simulation, there is a part dedicated to the recording of data in hipo files.</p>
<p>Look at <a href="https://github.com/ftouchte/gemc_source/blob/main/output/hipo_output.cc">gemc/source/output/hipo_output.cc</a></p>
<pre><code class="language-cpp">void hipo_output :: writeG4DgtIntegrated(outputContainer* output, vector&lt;hitOutput&gt; HO, string hitType, map&lt;string, gBank&gt; *banksMap) {...}
</code></pre>
<p>and <a href="https://github.com/ftouchte/gemc_source/blob/a38234b335fcc8a924a5e5716087d3fb66dedab6/output/gbank.cc#L345-L729">gemc/source/output/gbank.cc</a></p>
<pre><code class="language-cpp">map &lt;string, gBank&gt; read_banks(goptions gemcOpt, map &lt;string, string&gt; allSystems) { ... }
</code></pre>
<h2 id="step-4"><a class="header" href="#step-4">Step 4</a></h2>
<p>Update the database containing the bank definition. Go in <a href="https://github.com/gemc/detectors/blob/main/clas12/alert/ahdc/bank.pl">gemc/detectors/clas12/alert/ahdc/bank.pl</a></p>
<pre><code class="language-pl">insert_bank_variable(\%configuration, $bankname, "bankid",   $bankId, "Di", "$bankname bank ID");
	insert_bank_variable(\%configuration, $bankname, "sector",       1, "Di", "set to 0");
	insert_bank_variable(\%configuration, $bankname, "layer",        2, "Di", "hipo layer is superlayer*10 + layer");
	insert_bank_variable(\%configuration, $bankname, "component",    3, "Di", "wire number");
	insert_bank_variable(\%configuration, $bankname, "ADC_order",    4, "Di", "set to 0");
	insert_bank_variable(\%configuration, $bankname, "ADC_ADC",      5, "Di", "ADC integral from pulse fit");
	insert_bank_variable(\%configuration, $bankname, "ADC_time" ,    6, "Di", "adc time from pulse fit");
	insert_bank_variable(\%configuration, $bankname, "ADC_ped" ,     7, "Di", "pedestal from pulse analysis - currently set to doca");
    insert_bank_variable(\%configuration, $bankname, "ADC_newEntry" ,     8, "Dd", "this my new entry");
#	insert_bank_variable(\%configuration, $bankname, "TDC_order",    4, "Di", "set to 0");
#	insert_bank_variable(\%configuration, $bankname, "TDC_TDC",      5, "Di", "TDC integral from pulse fit");
#	insert_bank_variable(\%configuration, $bankname, "TDC_ped" ,     6, "Di", "pedestal from pulse analysis - currently set to doca");
	insert_bank_variable(\%configuration, $bankname, "hitn",        99, "Di", "hit number");

</code></pre>
<p>This is the end. Now you have to go in your <code>gemc/detectors/clas12/alert</code> (the place where you run <strong>gemc</strong>).</p>
<pre><code class="language-shell">cd ahdc
./ahdc.pl config.dat
cd ..
</code></pre>
<p>and run :</p>
<pre><code>/yourpathto/gemc/source/gemc alert.gcard -OUTPUT='hipo, ten_events.hipo' -N=10 -USE_GUI=0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="creation-of-the-ahdcwf136-bank"><a class="header" href="#creation-of-the-ahdcwf136-bank">Creation of the AHDC::wf136 bank?</a></h1>
<p>I wanted to create a new bank to save the digitized AHDC signal. I called it <code>AHDC::wf136</code>. wf refers "waveform" and 136 is the sampling number. (It is important to note that 136 is an abitrary number that should normally depends on <code>(int) (tmax-tmin)/44ns</code>. Here, the time windows is 6000 ns.)</p>
<p>The goal is to provide this digitized signal to the decoder in the reconstruction algorithm.</p>
<h2 id="step-1-classic"><a class="header" href="#step-1-classic">Step 1 (classic)</a></h2>
<p>In <code>gemc/source/hitprocess/clas12/alert/ahdc_hitprocess.cc</code>, I added :</p>
<pre><code class="language-cpp">for (int itr=1;itr&lt;=136;itr++){
                std::ostringstream sEntry;
                sEntry &lt;&lt; "wf136_s" &lt;&lt; itr;
                dgtz[sEntry.str()] = (int) SDgtz.at(itr-1);
}

</code></pre>
<h2 id="step-2-classic"><a class="header" href="#step-2-classic">Step 2 (classic)</a></h2>
<p>In <code>gemc/detectors/clas12/alert/ahdc/bank.pl</code>, I added these lines :</p>
<pre><code class="language-pl">for my $itr (1..136) {
                my $entry = "wf136_s$itr";
                insert_bank_variable(\%configuration, $bankname, $entry,$itr+3, "Di", "Digitized AHDC siganl : sample n° $itr");
}
</code></pre>
<p>To update the database, in <code>gemc/detectors/clas12/alert/ahdc</code>, I run  :</p>
<pre><code class="language-bash">./ahdc.pl config.dat
</code></pre>
<h2 id="step-3-less-classic"><a class="header" href="#step-3-less-classic">Step 3 (less classic)</a></h2>
<p>In <code>gemc/source/output/hipoSchema.h</code>, I declared :</p>
<pre><code class="language-cpp">class HipoSchema {
    // ...
    // detectors
    hipo::schema alertAhdcWF136chema;
    // ..
};
</code></pre>
<p>In <code>gemc/source/output/hipoSchema.cc</code>, I added :</p>
<pre><code class="language-cpp">// detectors
alertAhdcWF136chema = hipo::schema("AHDC::wf136",22400, 13); // &lt;== this line !
// ...
// detectors
std::ostringstream ListOfAhdcWF136;
ListOfAhdcWF136 &lt;&lt; "sector/B, layer/B, component/S";
for (int itr=1;itr&lt;=136;itr++){
        ListOfAhdcWF136 &lt;&lt; ", s" &lt;&lt; itr &lt;&lt; "/I";
}
alertAhdcWF136chema.parse(ListOfAhdcWF136.str());  // &lt;== this line !
// ...
schemasToLoad["AHDC::wf136"] = alertAhdcWF136chema; // &lt;== this line !
// ...
</code></pre>
<h2 id="step-4-very-subtle"><a class="header" href="#step-4-very-subtle">Step 4 (very subtle)</a></h2>
<p>The writting of the digitized bank is done in <code>hipo_output::writeDgtIntegrated(...)</code>.</p>
<p><code>hitType</code> is the name of the detector. For ALERT, <code>hitType == "ahdc"</code>.</p>
<p>The line bellow extract the structure of the AHDC bank.</p>
<pre><code class="language-cpp">gBank dgtBank     = getDgtBankFromMap(hitType, banksMap);
</code></pre>
<p>If you do a <code>cout &lt;&lt; dgtBank</code>, you will got something like that :</p>
<pre><code>======&gt; Show dgtBank
 &gt;&gt; Bank ahdc loaded with id 2 : ahdc bank ID
  &gt; Variable : sector	 id: 1	 type: Di	 Description: set to 1
  &gt; Variable : layer	 id: 2	 type: Di	 Description: hipo layer is superlayer*10 + layer
  &gt; Variable : component	 id: 3	 type: Di	 Description: wire number
  &gt; Variable : ADC_order	 id: 4	 type: Di	 Description: set to 1
  &gt; Variable : ADC_ADC	 id: 5	 type: Di	 Description: ADC integral from pulse fit
  &gt; Variable : ADC_time	 id: 6	 type: Dd	 Description: adc time from pulse fit
  &gt; Variable : ADC_ped	 id: 7	 type: Di	 Description: pedestal from pulse analysis - currently set to noise level
  &gt; Variable : ADC_integral	 id: 8	 type: Di	 Description: integral
  &gt; Variable : ADC_timestamp	 id: 9	 type: Dd	 Description: currently set to t_start
  &gt; Variable : ADC_t_cfd	 id: 10	 type: Dd	 Description: time from constant fraction discriminator
  &gt; Variable : ADC_mctime	 id: 11	 type: Dd	 Description: mc time - weighted average with Edep
  &gt; Variable : ADC_nsteps	 id: 12	 type: Di	 Description: nsteps
  &gt; Variable : ADC_mcEtot	 id: 13	 type: Dd	 Description: mcEtot
  &gt; Variable : hitn	 id: 99	 type: Di	 Description: hit number
  &gt; Variable : wf136_s1	 id: 4	 type: Di	 Description: Digitized AHDC siganl : sample n° 1
  &gt; Variable : wf136_s2	 id: 5	 type: Di	 Description: Digitized AHDC siganl : sample n° 2
  &gt; Variable : wf136_s3	 id: 6	 type: Di	 Description: Digitized AHDC siganl : sample n° 3
  &gt; Variable : wf136_s4	 id: 7	 type: Di	 Description: Digitized AHDC siganl : sample n° 4
  &gt; Variable : wf136_s5	 id: 8	 type: Di	 Description: Digitized AHDC siganl : sample n° 5
  &gt; Variable : wf136_s6	 id: 9	 type: Di	 Description: Digitized AHDC siganl : sample n° 6
  &gt; Variable : wf136_s7	 id: 10	 type: Di	 Description: Digitized AHDC siganl : sample n° 7
  &gt; Variable : wf136_s8	 id: 11	 type: Di	 Description: Digitized AHDC siganl : sample n° 8
  &gt; Variable : wf136_s9	 id: 12	 type: Di	 Description: Digitized AHDC siganl : sample n° 9
  &gt; Variable : wf136_s10	 id: 13	 type: Di	 Description: Digitized AHDC siganl : sample n° 10
  &gt; Variable : wf136_s11	 id: 14	 type: Di	 Description: Digitized AHDC siganl : sample n° 11
  &gt; Variable : wf136_s12	 id: 15	 type: Di	 Description: Digitized AHDC siganl : sample n° 12
  &gt; Variable : wf136_s13	 id: 16	 type: Di	 Description: Digitized AHDC siganl : sample n° 13
  &gt; Variable : wf136_s14	 id: 17	 type: Di	 Description: Digitized AHDC siganl : sample n° 14
  &gt; Variable : wf136_s15	 id: 18	 type: Di	 Description: Digitized AHDC siganl : sample n° 15
  &gt; Variable : wf136_s16	 id: 19	 type: Di	 Description: Digitized AHDC siganl : sample n° 16
  &gt; Variable : wf136_s17	 id: 20	 type: Di	 Description: Digitized AHDC siganl : sample n° 17
  // etc...
</code></pre>
<p>At this step, I was confident with the fact that I could access my new bank. To continue, I just got inspire by the code already written. As AHDC::wf136 is neither of type <code>adc</code> nor <code>tdc</code>, I had to do some stuffs manually. So I extracted the schema and the bank like that :</p>
<pre><code class="language-cpp">// Specific to AHDC and AHDC::wf136
hipo::schema ahdcWF136Schema = (output-&gt;hipoSchema)-&gt;schemasToLoad["AHDC::wf136"];
hipo::bank ahdcWF136Bank(ahdcWF136Schema, HO.size());
//std::cout &lt;&lt; "======&gt; Show ahdcWF136Bank" &lt;&lt; std::endl;
//ahdcWF136Bank.show(); // to have a preview the AHDC::wf136 // of course, at this step, all entries are set to 0
</code></pre>
<p>It remained to fill the bank when hitType == "ahdc" :</p>
<pre><code class="language-cpp">for(auto &amp;bankName : dgtBank.orderedNames ) {
// ...
    if(hasADCBank) {
				
<span class="boring">        // looping over the hits
</span><span class="boring">        for(unsigned int nh=0; nh&lt;HO.size(); nh++) {
</span><span class="boring">            
</span><span class="boring">            map&lt;string, double&gt; theseDgts = HO[nh].getDgtz();
</span><span class="boring">            for(auto &amp;thisVar: theseDgts) {
</span><span class="boring">               
</span><span class="boring">                // found data match to bank definition
</span><span class="boring">                if(thisVar.first == bname) {
</span><span class="boring">                    
</span><span class="boring">                    string varType = dgtBank.getVarType(thisVar.first);
</span><span class="boring">                    
</span><span class="boring">                    // sector, layer, component are common in adc/tdc so their names are w/o prefix
</span><span class="boring">                    // sector, layers are "Bytes"
</span>                    if(bname == "sector" || bname == "layer") {
                        detectorADCBank.putByte(bname.c_str(), nh, thisVar.second);
                        if (hitType == "ahdc") {ahdcWF136Bank.putByte(bname.c_str(), nh, thisVar.second);} // &lt;== This line !
                    } else if(bname == "component") {
                        detectorADCBank.putShort(bname.c_str(), nh, thisVar.second);
                        if (hitType == "ahdc") {ahdcWF136Bank.putShort(bname.c_str(), nh, thisVar.second);} // &lt;== This line !
                    } else {
<span class="boring">                        // all other ADC vars must begin with "ADC_"
</span><span class="boring">                        if(bname.find("ADC_") == 0) {
</span><span class="boring">                            string adcName = bname.substr(4);
</span><span class="boring">                            if(varType == "i") {
</span><span class="boring">                                detectorADCBank.putInt(adcName.c_str(), nh, thisVar.second);
</span><span class="boring">                            } else if(varType == "d") {
</span><span class="boring">                                detectorADCBank.putFloat(adcName.c_str(), nh, thisVar.second);
</span><span class="boring">                            }
</span>                        } else if(bname.find("wf136_") == 0) { // actually this prefix only appears in AHDC
                            if (hitType == "ahdc") {
                                string wf136Name = bname.substr(6);
                                if (varType == "i"){
                                    ahdcWF136Bank.putInt(wf136Name.c_str(), nh, thisVar.second); // &lt;== This line !
                                }
                            }
                        }
                    }
// ...
}
</code></pre>
<h2 id="result"><a class="header" href="#result">Result</a></h2>
<p><img src="tutorials/./images/ahdc_wf136_bank0.png" alt="AHDC::wf136_isthere" />
<img src="tutorials/./images/ahdc_wf136_bank.png" alt="AHDC::wf136" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ahdc-signal"><a class="header" href="#ahdc-signal">AHDC signal</a></h1>
<p>The process to obtain this signal is well explained in <a href="https://ftouchte.github.io/projects/">Preparation of the ALERT experiment at Jefferson Lab (chapter 4)</a>. Here is a simulation of the AHDC signal.  This section presents the definition of each decoding output.</p>
<p><img src="ahdc/../images/SignalDecoded.png" alt="AHDC signal + decoding" /></p>
<h2 id="max_value"><a class="header" href="#max_value">max_value</a></h2>
<p>This the amplitude of the signal. It is important to note that at this stage we only have a digitized signal. A way to extract a precise value of this amplitude is to do a Gaussian fit using 5 or more points around the sample maximum and theoretically determine the maximum of this Gaussian. However, this decoding algorithm needs to be very fast, whereas fits usually take a long time. We have do it simple : the amplitude is simply the average of the 5 samples around the sample maximum. Actually, it may appears that the signal is saturated like in the figure bellow. In that case, the amplitude corresponds to the <code>adc_max</code> but the moment when the signal reach it is the middle of the plateau.</p>
<p><img src="ahdc/../images/SignalExamplePlateau.png" alt="SignalExamplePlateau.png" /></p>
<h2 id="noise_level"><a class="header" href="#noise_level">noise_level</a></h2>
<p>Also called pedestal, it gives an indication the mean value of the noise. As we can't predict the noise, for the moment, we're using an average of the first five samples.</p>
<h2 id="threshold"><a class="header" href="#threshold">threshold</a></h2>
<p>This is the half of the amplitude after removing the noise level. It is used to determine <code>t_start</code> and <code>t_ovr</code>.</p>
<h2 id="t_start"><a class="header" href="#t_start">t_start</a></h2>
<p>This is the moment when the signal reaches the half of its amplitude. Because of the fluctuation due to the noise, we agree that it corresponds to the last past below the threshold and before <code>max_value</code>. As the time is also sampled, we cannot expect <code>t_start</code> having the form <code>t_min + i*samplingTime</code>. Instead, it exists <code>i</code> such as \(t_i &lt; t_{start} &lt; t_{i+1}\). If \(S_i\) is the value of the signal at \(t_i\), approximating the signal by a straight line gives the equation :</p>
<p>\[
y = \frac{S_{i+1} - S_i}{t_{i+1}-t_i} (t - t_i) + S_i := \mbox{slope}*(t - t_i) + S_i
\]</p>
<p>When \(y = \mbox{threshold}\), \(t = t_{start}\). Hence :</p>
<p>\[<br />
t_{start} = t_i + \frac{\mbox{threshold} - S_i}{\mbox{slope}}
\]</p>
<h2 id="t_ovr"><a class="header" href="#t_ovr">t_ovr</a></h2>
<p>This is the time minus <code>t_start</code> when the signal falls below the threshold after having reached its maximum value. Because of the fluctuation due to the noise, we agree that it corresponds to the first pass below the threshold and after <code>max_value</code>. It is determined in the same way that <code>t_start</code>.</p>
<h2 id="integral"><a class="header" href="#integral">integral</a></h2>
<p>This is the green area shown in the figure <a href="ahdc/simu_signal.html#ahdc-signal">SignalDecoded</a>. It is equals to the sum of all bins (samples) between <code>t_start</code> and <code>t_ovr</code>.</p>
<h2 id="t_cfd"><a class="header" href="#t_cfd">t_cfd</a></h2>
<p>This is the time obtained using the Constant Fraction Discriminator (CFD) algorithm. The CFD has the particularity of giving the time when the signal reaches a constant fraction of its amplitude. The process to determine this time is illustrated by the figure bellow. The CFD depends on two parameters : a fraction factor and a delay. Currently, the fraction factor is set to $0.3$ and the delay to 5 (in index units) but they have to be optimized !</p>
<p><img src="ahdc/../images/cfd-algorithm.png" alt="AlgoCFD.png" />
N.B : This image has been taken from <a href="https://www.edinst.com/blog/constant-fraction-discrimination/">EDINBURGH INSTRUMENTS</a>.</p>
<p><img src="ahdc/../images/SignalCFDApplied.png" alt="SignalCFDApplied.png" /></p>
<h2 id="decoding-output-vs-ahdcadc-entries"><a class="header" href="#decoding-output-vs-ahdcadc-entries">Decoding output vs AHDC::adc entries</a></h2>
<div class="table-wrapper"><table><thead><tr><th>AHDC::adc entries</th><th>Decoding output</th></tr></thead><tbody>
<tr><td>ADC</td><td>max_value</td></tr>
<tr><td>time</td><td>t_ovr</td></tr>
<tr><td>ped</td><td>noise_level</td></tr>
<tr><td>integral</td><td>integral</td></tr>
<tr><td>timestamp</td><td>t_start</td></tr>
<tr><td>t_cfd</td><td>t_cfd</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="références"><a class="header" href="#références">Références</a></h1>
<ul>
<li>
<p><a href="https://clasweb.jlab.org/wiki/index.php/ALERT_Software_and_Simulations/GEMC_coatjava_setup_on_farm">ALERT Software Wiki</a></p>
</li>
<li>
<p><a href="https://clasweb.jlab.org/wiki/index.php/CLAS12_Software_Center#tab=Analysis">CLAS12 Software Center</a></p>
</li>
<li>
<p><a href="https://github.com/gavalian/hipo">C++ framework for HIPO files</a></p>
</li>
<li>
<p><a href="https://github.com/ftouchte/gemc_source">My version of gemc source</a></p>
</li>
<li>
<p><a href="https://github.com/ftouchte/alert">My non gemc source code </a></p>
</li>
<li>
<p><a href="https://rust-lang.github.io/mdBook/index.html">Build your own mdBook</a></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
